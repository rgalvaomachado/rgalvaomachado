name: Gerador de Cartão de Visita (Injeção Markdown - FIX)

on:
  schedule:
    - cron: '0 0 * * *' 
  workflow_dispatch:

jobs:
  update_readme:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          # Token necessário para o checkout e para o commit no final
          token: ${{ secrets.GH_TOKEN_PROFISSIONAL }}

      # Passo 1: Busca dos Dados Profissionais via GraphQL
      - name: Fetch and Inject Data into README
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GH_TOKEN_PROFISSIONAL }}
          script: |
            const fs = require('fs');

            const query = `
              query {
                user(login: "romulosuperlogica") {
                  contributionsCollection {
                    totalCommitContributions
                    totalPullRequestContributions
                    totalPullRequestReviewContributions
                  }
                }
              }`;
            
            const result = await github.graphql(query);
            const contributions = result.user.contributionsCollection;
            
            // Função para formatar números (ex: 1.271)
            const formatNumber = (num) => num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");

            const COMMITS = formatNumber(contributions.totalCommitContributions);
            const PRS_OPENED = formatNumber(contributions.totalPullRequestContributions);
            const PRS_REVIEWED = formatNumber(contributions.totalPullRequestReviewContributions);

            // Conteúdo Markdown Final com injeção de dados (Template Literal)
            const readmeContent = `
# Esses são dados da minha conta profissional

**[@romulosuperlogica](https://github.com/romulosuperlogica)** | Desenvolvedor | Contribuições Profissionais

<p align="center">
  <table align="center" style="text-align: center;">
    <thead>
      <tr>
        <th style="font-size: 16px;">Commits (Último Ano)</th>
        <th style="font-size: 16px;">PRs Abertos</th>
        <th style="font-size: 16px;">Reviews Feitas</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td style="font-size: 24px; font-weight: bold; padding: 10px 20px;">${COMMITS}</td>
        <td style="font-size: 24px; font-weight: bold; padding: 10px 20px;">${PRS_OPENED}</td>
        <td style="font-size: 24px; font-weight: bold; padding: 10px 20px;">${PRS_REVIEWED}</td>
      </tr>
    </tbody>
  </table>
</p>

Ficou com dúvida? Acesse diretamente meu perfil completo em [github.com/romulosuperlogica](https://github.com/romulosuperlogica).
`;
            // Escreve o conteúdo final no README.md
            fs.writeFileSync('README.md', readmeContent);

      # Passo 2: Commit do Novo README.md
      - name: Commit changes
        uses: EndBug/add-and-commit@v9
        with:
          author_name: GitHub Actions
          author_email: action@github.com
          message: 'chore(readme): Update professional card data (Markdown)'
          add: 'README.md'
          # Usa o Token para permitir a escrita (commit) no repo
          token: ${{ secrets.GH_TOKEN_PROFISSIONAL }}
